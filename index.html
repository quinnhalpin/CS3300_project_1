<!DOCTYPE html>
<html>
<head>
	<title>Project One</title>
	<script src="https://d3js.org/d3.v4.min.js"></script>
	<script src="http://d3js.org/topojson.v2.min.js"></script>
</head>
<style>
	svg { border: solid #ccc 1px; }
</style>
<body>
	<div id = "p1">
		<p>
			CS: 3300 Project 1: Static Visualization of Migration in the Middle East
		</p>
	</div>
	<div id = "p2">
		<p>
			Closer Look
		</p>
	</div>
	<div id = "p3">
		<p>
			Showcasing country area
		</p>
	</div>
	<div id = "p4">
		<p>
			Path of every country
		</p>
	</div>
  <div id = "p5">
    <p>
      Infant Mortality vs Net Migration Rate of Middle Eastern Countries and India in 2015
    </p>
  </div>
	<script type="text/javascript">
    var dataset, nestedData, rawData, countries, popAreaData;
    var projection = d3.geoMercator().scale(125);
    var projection_out = d3.geoMercator().scale(300);
    var projection3 = d3.geoMercator().scale(300);
    var pathGenerator2 = d3.geoPath().projection(projection);
    var pathGenerator3 = d3.geoPath().projection(projection3);
    var svgMap = d3.select("#p1").append("svg").attr("width", 500).attr("height", 500)
                .style("background", "#FCFDFF"); //makes the svg map background light blue
    var svgZoom = d3.select("#p1").append("svg").attr("width", 500).attr("height", 500)
                .style("background", "#FCFDFF");
    var svg3 = d3.select("#p3").append("svg").attr("width", 500).attr("height", 500);
    var svg4 = d3.select("#p4").append("svg").attr("width", 500).attr("height", 500);
    var svgChart = d3.select("#p2").append("svg").attr("width", 700).attr("height", 400);
    var infantMort_netmigrate_svg = d3.select("#p5").append("svg").attr("width", 600).attr("height", 600);

    d3.queue()
    .defer(d3.csv, "large-tabular.csv")
    .defer(d3.json, "world-50m.json")
    .defer(d3.json, "middle_east_pop_area.json")
    .await(done_function);
    scale_country_id = {
      48: 7,
      818: .4,
      364: .2,
      368: .4,
      376: 1,
      400: .8,
      414: 1.3,
      422: 1.5,
      512: .4,
      275: 2,
      634: 2,
      682: .2,
      760: .7,
      792: .4,
      784: 1,
      887: .5
    }
    small_scale_country_id = {
      48: 7,
      818: .2,
      364: .15,
      368: .25,
      376: .8,
      400: .6,
      414: 1.3,
      422: 1.5,
      512: .4,
      275: 2,
      634: 2,
      682: .15,
      760: .4,
      784: .6,
      792: .25,
      887: .4,
      356: .15
    }
    small_country_arr = {
      "Yemen": {"ind":15, "id": 887}, 
      "Egypt": {"ind":1, "id": 818}, 
      "Bahrain": {"ind":0, "id":48}, 
      "Iraq": {"ind":3, "id": 368}, 
    }
    banned_country = {
        "IRN": {"ind":2, "id": 364}, 
        "IRQ": {"ind":3, "id": 368},
        "SYR": {"ind":12, "id": 760},  
        "YEM": {"ind":15, "id": 887},
        "LBY": {"ind":16, "id":434},
        "SDN": {"ind":17, "id":736},
        "SOM": {"ind":18, "id":706}
    }
   country_id = {
      "BHR": {"name":"Bahrain", "ind":0, "id":48}, 
      "EGY": {"name":"Egypt", "ind":1, "id": 818}, 
      "IRN": {"name":"Iran", "ind":2, "id": 364}, 
      "IRQ": {"name":"Iraq", "ind":3, "id": 368}, 
      "ISR": {"name":"Israel", "ind":4, "id": 376}, 
      "JOR": {"name":"Jordan", "ind":5, "id": 400}, 
      "KWT": {"name":"Kuwait", "ind":6, "id": 414}, 
      "LBN": {"name":"Lebanon", "ind":7, "id": 422}, 
      "OMN": {"name":"Oman", "ind":8, "id": 512}, 
      "PSE": {"name":"Palestine", "ind":9, "id": 275}, 
      "QAT": {"name":"Qatar", "ind":10, "id": 634}, 
      "SAU": {"name":"Saudi Arabia", "ind":11, "id": 682}, 
      "SYR": {"name":"Syria", "ind":12, "id": 760}, 
      "ARE": {"name":"U. Arab Emirates", "ind": 14, "id": 784}, 
      "TUR":{"name":"Turkey", "ind":13, "id": 792}, 
      "YEM": {"name":"Yemen", "ind":15, "id": 887}      
    }
    id_to_acry = {
      "48": "BHR",
      "818" : "EGY",
      "364" : "IRN",
      "368" : "IRQ",
      "376" : "ISR",
      "400" : "JOR",
      "414" : "KWT",
      "422" : "LBN",
      "512" : "OMN",
      "275" : "PSE",
      "634": "QAT", 
      "682" : "SAU", 
      "760": "SYR", 
      "784" : "ARE",
      "792" : "TUR",
      "887": "YEM", 
    }
    id_to_country = {
      "356": "India",
      "48": "Bahrain",
      "818" : "Egypt",
      "364" : "Iran",
      "368" : "Iraq",
      "376" : "Israel",
      "400" : "Jordan",
      "414" : "Kuwait",
      "422" : "Lebanon",
      "512" : "Oman",
      "275" : "Palestine",
      "634": "Qatar", 
      "682" : "Saudi Arabia", 
      "760": "Syria", 
      "784" : "United Arab Emirates",
      "792" : "Turkey",
      "887": "Yemen", 
    }

    middle_east_ids = [48,818,364,368,376,400,414,422,512,275,634,682,760,784,792,887];
    middle_east_plus_india_ids = [356,48,818,364,368,376,400,414,422,512,275,634,682,760,784,792,887];
    

    /* This function returns an array countryData containing an object for each country with fields of the 2015 data for each variable*/
    function done_function(error, csv_data, world_json_data, pop_area) {
      dataset= csv_data;
      nestedData = d3.nest()
      .key(function (d){ return d.REF_AREA;}).entries(csv_data);

      countryData = nestedData.map(function(country){
        var result = {Country: country.key};
        country.values.forEach(function (d){
        if(d.TIME_PERIOD =="2015"){
            if (d.INDICATOR == "SM_POP_NETM") {
                result.NetMigration = d.OBS_VALUE;
                }
                else if(d.INDICATOR == "SM_POP_NMRT"){
                    result.NetMigRate = d.OBS_VALUE;
                }
                else if(d.INDICATOR == "SP_POP_CHGE"){
                    result.PopChange = d.OBS_VALUE;
                }
                else if(d.INDICATOR == "SP_POP_TOTL"){
                    result.PopTotal = d.OBS_VALUE;
                }
                else if(d.INDICATOR == "SP_DYN_LE00"){
                    result.LifeExpect = d.OBS_VALUE;
                }
                else if(d.INDICATOR == "SH_DYN_IMRT"){
                    result.InfantMort = d.OBS_VALUE;
                }
                else if (d.INDICATOR == "ID"){
                    result.CountryId = d.OBS_VALUE;
                }
            }
        });
        return result;
      });
      //Remove the underfined element in the array
      countryData = countryData.filter(function(c) {
          return c.Country !== "undefined";
      }); 

      //Sort the countryData by the net migration
      countryData.sort(function (a,b) {
          return parseFloat(a.NetMigration) - parseFloat(b.NetMigration);
      });

      var scaleOrdinal = d3.scaleOrdinal(d3.schemeCategory20c);
      var monochromaticColors = ['#46ff03','#3b9606','#186901'];
      var complementaryColors = ['#e37d00','#39b80e','#0716ba'];
      // Brown and blue['#1e38ab','#030200','#a86420'];
      //Green and blue['#46ff03','#030200','#db7f15'];
      // Green and red [#5bad0e,'#030200',#a80e59];
      var grayColors = ['#d3d3d3','#d3d3d3'];

      var redBlue = [
            /*reds dark to light:*/ "#E21D2D", "#FF3041", "#F75B5B", "#fff",
            /*blues light to dark:*/   "#4281AA", "#346687"];
            //extra red  "#78C0E0",


      var colorScaleMap = d3.scaleLinear().domain([-400,-237.5,-75,0,125,250]).range(redBlue); // Migration scale
      var grayScale = d3.scaleLinear().domain([0, 100]).range(grayColors);
            
      //----------------Add the zoomed out map svg----------------
      rawData = world_json_data;
      countries = topojson.feature(rawData, rawData.objects.countries);
      id_in_dict = function(val, arr){return Object.values(arr).reduce((a,x) => a || val == x.id, false)}
      projection_out.fitExtent([[-1500,-500], [3*svgMap.attr("width"), 3*svgMap.attr("height")]], countries);
      projection.fitExtent([[-3582,-1500], [5.9*svgZoom.attr("width"), 5.9*svgZoom.attr("height")]], countries);
      pathGenerator_out = d3.geoPath().projection(projection_out);
      pathGenerator2 = d3.geoPath().projection(projection);
      var path_all = svgMap.selectAll("path.country").data(countries.features);
      
      path_all.enter().append("path").attr("class", "country")
      .merge(path_all)
      .attr("d", function(country){ 
        return pathGenerator_out(country);
      })
      .attr("id", function(country){return country.id;})
      .style("stroke",function(country, ind) {
      	if(country.id in banned_country ){
      		return "red";
      	}
      })
      .style("fill", function(country, ind) {
        for (var i = 0; i <= countryData.length - 1; i++) {
            if(countryData[i].CountryId == country.id ){
                console.log("net:" +countryData[i].NetMigration)
                return colorScaleMap(countryData[i].NetMigration); 
            }
        }
        return grayScale(ind+5 % 20);
      }
      //tried to fix the for loop above but couldnt figure it out
      //   function(){
      //   countryData.forEach(function (d) {
      //       if((d.Country in country_id) && (country_id[d.Country].id == country.id)){
      //           console.log("net:" + d.NetMigration)
      //           return colorScaleMap(d.NetMigration);
      //       }
      //   });
      // }


      );
      svgMap.append("circle").attr("r", 124)
        .style("fill", "none")
        .style("stroke", "black")
        .attr("cx", 247)
        .attr("cy", 265);
      //line on top side of circle
      svgMap.append("line")
        .attr("x1", 247) 
        .attr("y1", 141) 
        .attr("x2", 500)
        .attr("y2", 0)
        .style("stroke", "black")
        .style("stroke-width", 1);
      //line on left side of circle
      svgMap.append("line")
        .attr("x1", 247) 
        .attr("y1", 389) 
        .attr("x2", 500)
        .attr("y2", 500)
        .style("stroke", "black")
        .style("stroke-width", 1);

      //----------------Create the zoomed in map----------------
      var paths = svgZoom.selectAll("path.country").data(countries.features);
      paths.enter().append("path").attr("class", "country")
      .merge(paths)
      .attr("d", function(country){
        if (Object.keys(id_to_country).includes('' + country.id)){
          return pathGenerator2(country);
        }
      })
      .attr("id", function(country){return country.id;})
      .style("fill", function(country, ind) {
                    	// This seems like an inefficient way of doing this..
         for (var i = 0; i <= countryData.length - 2; i++) {
             if(countryData[i].CountryId == country.id){return colorScaleMap(countryData[i].NetMigration);}
          }
      return grayScale(ind+5 % 20);
      });
    //----------------Create Bar Chart of Net Migration----------------
      //var migrationExtent = d3.extent(countryData,
      //     function (d) { return d.NetMigration; });
      var xScale = d3.scaleLinear().domain([0, 15]).range([40, 655]);
      var migrationScale = d3.scaleLinear().domain([-80.0004,249.9996]).range([340, 20]);

      i=0;
      countryData.forEach(function (d) {
        if(d.Country in country_id){
          y2 = migrationScale(d.NetMigration);
          svgChart.append("line")
          .attr("x1", xScale(i))
          .attr("y1", migrationScale(0))
          .attr("x2", xScale(i))
          .attr("y2", y2)
          .style("stroke", "black")
          .style("stroke-width", 20)
          .style("opacity", 0.75);

          if(d.NetMigration<1){
            svgChart.append("text")
            .text(country_id[d.Country].name)
            .attr("x", xScale(i))
            .attr("y", y2+10)
            .attr("font-size", "10px")
            .style("fill", "black")
            .attr("text-anchor", "middle");
          }
          else if(d.Country=="ARE"){
            svgChart.append("text")
            .text(country_id[d.Country].name)
            .attr("x", xScale(i)-6)
            .attr("y", y2-5)
            .attr("font-size", "10px")
            .style("fill", "black")
            .attr("text-anchor", "middle");
          }
          else{
            svgChart.append("text")
            .text(country_id[d.Country].name)
            .attr("x", xScale(i))
            .attr("y", y2-5)
            .attr("font-size", "10px")
            .style("fill", "black")
            .attr("text-anchor", "middle");
          }
          i+=1;
        }
      });
      //----------------Create Plot of Country Area----------------   
      popAreaData = pop_area.countries;
      popAreaData.length
      var radiusScale = d3.scaleLinear().domain([0,9]).range([40, 170]);
      var xScale = d3.scaleLinear().domain([0,3]).range([50, 450]);
      var yScale = d3.scaleLinear().domain([0,3]).range([50, 450]);
      var areaExtent = d3.extent(popAreaData,
        function (d) { return Math.sqrt(d.areaInSqKm); });
      //console.log(areaExtent)
      var rScale = d3.scaleLinear().domain(areaExtent).range([3,10]);
      
      i = 0;
      popAreaData.forEach(function(d){
        g = svg3.append("g")
          .attr("transform", "translate(" + xScale(i%4) + ", " + yScale(Math.floor(i/4)) + ")")
          .attr("cx", xScale(i%4))
          .attr("cy", yScale(Math.floor(i/4)));
        g.append("circle").attr("r",rScale(Math.sqrt(d.areaInSqKm)))
          .style("fill", "red")
          .attr("opacity", .8);
        g.append("text").style("font-size", "8pt")
          .text(d.countryName)
          .style("font-family", "Alegreya Sans")
          .attr("x", -15)
          .attr("y", -20);
          i += 1;
      });
      //----------------Create Icon for Every Country-------------------  
      projection3.fitExtent([[-2800,-1200], [5*svg4.attr("width"), 5*svg4.attr("height")]], countries);
      pathGenerator3 = d3.geoPath().projection(projection3);
      var paths_special = svg4.selectAll("path.country").data(countries.features);
      country_for_id = function(val, arr){return Object.values(arr).reduce((a,x) => a.id || Object.key , false)}
      var xScaleCountry = d3.scaleLinear().domain([0,4]).range([100,400]);
      var yScaleCountry = d3.scaleLinear().domain([0,4]).range([100,400]);
      var placeScale = d3.scaleLinear().domain([0,1000]).range([0,143])
      var xScaleLarge = d3.scaleLinear().domain([0,4]).range([50, 450]);
      var yScaleLarge = d3.scaleLinear().domain([0,4]).range([50, 450]);
      i = 0;
      var middle_east_plus_india = countries.features.filter((a) => middle_east_plus_india_ids.includes(a.id));
      var mideast = countries.features.filter((a) => middle_east_ids.includes(a.id));
      var groups = svg4.selectAll('g')
      .data(middle_east_plus_india)
      .enter()
      .append('g')

      groups
        .append('path')
        .attr('d', function(country){
          if (country.id == 784){
            console.log("found country")
          } 
          if (Object.keys(id_to_country).includes('' + country.id)){
            return pathGenerator2(country);
          }})
        .style("fill", function(country, ind) {
          return scaleOrdinal(ind % 20);
        })
        .attr("transform", function(country, id) {
	        if (Object.keys(id_to_country).includes('' + country.id)){
            [x_cent,y_cent] = projection(d3.geoPath().centroid(country));
	          x = -x_cent*small_scale_country_id[country.id];
	          y= -y_cent*small_scale_country_id[country.id];
	          return "translate("+ x +","+ y +")translate("+xScaleLarge(id%5)+","+yScaleLarge(Math.floor(id/5))+")  scale(" + small_scale_country_id[country.id]+ ") ";
	        }
	      });
      groups
        .append('text')
        .style("font-size", "10pt")
        .attr("transform", function(country,id) {
          if (Object.keys(id_to_country).includes('' + country.id)){
            x = xScaleLarge(id%5) - 13;
            y = yScaleLarge(Math.floor(id/5));
            return "translate("+x+","+y+")";
          }})
        .text(function(country){
          return id_to_country['' + country.id];
        });
      // ---------Infant Mortality vs Migration Rate Scatter Plot---------------
      // set up scales
      var xScale_infant_migrate = d3.scaleLinear().domain([0, 60]).range([15, 550]);
      var yScale_infant_migrate = d3.scaleLinear().domain([-16, 12]).range([550, 15]); 
      var botAxis_infant_mitrate = d3.axisBottom(xScale_infant_migrate).ticks(5).tickSize(9);
      var leftAxis_infant_mitrate = d3.axisLeft(yScale_infant_migrate).ticks(5).tickSize(9);
      
      // set up country icons
      var country_group_inf_mitrate = infantMort_netmigrate_svg.selectAll('g')
      .data(middle_east_plus_india)
      .enter()
      .append('g')
      // draw countries
      function find_country_index(id){
        notFound = true;
        i = 0;
        str_id = '' + id;
        if (str_id.length == 2){
          str_id = "0" + str_id;
        }
        while (i < countryData.length & notFound){
          if (countryData[i].CountryId == str_id){
            notFound = false;
            return i;
          }
          i += 1;
        }
        console.log("find_country couldn't find")
        console.log(id)
      }
      
      country_group_inf_mitrate
        .append('path')
        .attr('d', function(country){
          if (Object.keys(id_to_country).includes('' + country.id)){
            console.log(country.id)
            return pathGenerator2(country);
          }})
        .style("fill", function(country, ind) {
          return scaleOrdinal(ind % 20);
        })
        .attr("transform", function(country, id) {
          if (Object.keys(id_to_country).includes('' + country.id)){
            [x_cent,y_cent] = projection(d3.geoPath().centroid(country));
            top_left_x = -x_cent*small_scale_country_id[country.id];
            top_left_y= -y_cent*small_scale_country_id[country.id];
            country_index = find_country_index(country.id)
            console.log(countryData[country_index] )

            if (countryData[country_index] != undefined){
              infant_x = xScale_infant_migrate(Number(countryData[country_index].InfantMort))
              migrate_y = yScale_infant_migrate(Number(countryData[country_index].NetMigRate))
            }
            else{
              console.log("cannot find")
              console.log(country_index)
              infant_x = 0;
              migrate_y = 0;
            }
            return "translate("+ top_left_x +","+ top_left_y +")translate("+
            infant_x+","+migrate_y+")  scale(" + small_scale_country_id[country.id]+ ") ";
          }
        });
      // add country name
      country_group_inf_mitrate
        .append('text')
        .style("font-size", "10pt")
        .attr("transform", function(country,ind) {
          if (Object.keys(id_to_country).includes('' + country.id)){
            country_index = find_country_index(country.id)
            if (countryData[country_index] != undefined){
              infant_x_text = xScale_infant_migrate(Number(countryData[country_index].InfantMort)) - 12;
              migrate_y_text = yScale_infant_migrate(Number(countryData[country_index].NetMigRate));
            }
            else{
              infant_x_text = 0;
              migrate_y_text = 0;
            }
            return "translate("+infant_x_text+","+migrate_y_text+")";
          }})
        .text(function(country){
          return id_to_country['' + country.id];
        });

      // add axeses
      var inf_mitrate_plot = infantMort_netmigrate_svg.append("g");
      inf_mitrate_plot.append("g").style("font", "10px times")
        .call(botAxis_infant_mitrate).attr("transform","translate(20,242)");
      inf_mitrate_plot.append("g").style("font", "10px times")
        .call(leftAxis_infant_mitrate).attr("transform","translate(35,0)");

      inf_mitrate_plot
        .append("text")
        .style("font-size", "12pt")
        .attr("x","250")
        .attr("y", "300")
        .text("Infant Mortality Rate")
      inf_mitrate_plot
        .append("text")
        .style("font-size", "12pt")
        .attr("x","-250")
        .attr("y", "15")
        .attr("transform", "rotate(-90)")
        .text("Net Migration Rate")
    }


	 </script>
</body>
</html>
